<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akƒ±llƒ± Dok√ºman Asistanƒ±</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --text: #1e293b;
            --error: #ef4444;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        h1 {
            text-align: center;
            color: var(--primary);
            margin: 0 0 20px 0;
            font-size: 1.5rem;
        }

        /* Main Layout */
        .container {
            display: flex;
            gap: 20px;
            flex: 1;
            overflow: hidden;
            /* Scroll chat/files independently */
        }

        /* Sidebar (Files) */
        .sidebar {
            width: 320px;
            min-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Main (Chat) */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            /* Flexbox overflow fix */
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .files-card {
            height: 100%;
            overflow: hidden;
        }

        /* Drag & Drop Visuals */
        .card.dragover {
            border-color: var(--primary);
            background-color: #eff6ff;
            border: 2px dashed var(--primary);
        }

        /* File List */
        .upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #fff;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9em;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-name {
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 200px;
        }

        .remove-btn {
            color: var(--error);
            cursor: pointer;
            padding: 2px 8px;
            font-weight: bold;
            font-size: 1.2em;
        }

        .upload-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-add {
            background: #e2e8f0;
            color: #334155;
            border: 1px solid #cbd5e1;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
        }

        button {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Chat Area */
        #chat-history {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            background: #fff;
            margin-bottom: 15px;
        }

        .message-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        .message {
            padding: 12px 18px;
            border-radius: 16px;
            max-width: 85%;
            line-height: 1.5;
            position: relative;
        }

        .user-container {
            align-items: flex-end;
        }

        .bot-container {
            align-items: flex-start;
        }

        .user-msg {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .bot-msg {
            background: #f1f5f9;
            color: var(--text);
            border-bottom-left-radius: 4px;
        }

        .warning-msg {
            background: #fee2e2;
            color: #991b1b;
            text-align: center;
            border: 2px solid #ef4444;
            width: 100%;
            max-width: 100%;
        }

        .time {
            font-size: 0.7em;
            margin-top: 4px;
            opacity: 0.7;
            align-self: flex-end;
        }

        .user-container .time {
            margin-right: 5px;
            color: #64748b;
        }

        /* User mesajƒ±nƒ±n saati dƒ±≈üarƒ±da olsun */
        .bot-container .time {
            margin-left: 5px;
            color: #64748b;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex: 1;
            padding: 14px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            outline: none;
        }

        .status {
            margin-top: 10px;
            font-weight: bold;
            font-size: 0.85em;
            text-align: center;
        }

        .status.success {
            color: #16a34a;
        }

        .status.error {
            color: var(--error);
        }

        .drop-hint {
            text-align: center;
            color: #64748b;
            font-size: 0.8em;
            margin-top: 10px;
            border-top: 1px dashed #ccc;
            padding-top: 10px;
        }
    </style>
</head>

<body>

    <h1>ü§ñ Yerel Dok√ºman Asistanƒ±</h1>

    <div class="container">
        <!-- Sidebar: Dosya Y√∂netimi -->
        <div class="sidebar">
            <div class="card files-card" id="dropZone">
                <div class="upload-header">
                    <h3>üìÇ Dosyalar</h3>
                    <span id="fileCount" style="color: #64748b; font-size: 0.8em;">0 dosya</span>
                </div>

                <div class="file-list" id="fileListContainer"></div>

                <div class="upload-actions">
                    <button class="btn-add" onclick="document.getElementById('fileInput').click()">+ Dosya Ekle</button>
                    <button class="btn-primary" id="analyzeBtn" onclick="startAnalysis()" disabled>üöÄ Analizi
                        Ba≈ülat</button>
                </div>

                <div class="drop-hint">S√ºr√ºkle & Bƒ±rak</div>
                <input type="file" id="fileInput" multiple style="display: none" onchange="addFiles(this.files)">
                <div id="uploadStatus" class="status"></div>
            </div>
        </div>

        <!-- Main: Chat -->
        <div class="main-chat">
            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <h3 style="margin:0;">üí¨ Sohbet</h3>
                    <button onclick="clearChat()"
                        style="background:none; border:none; color:#94a3b8; padding:0; font-size:0.8em; cursor:pointer;">Temizle</button>
                </div>

                <div id="chat-history">
                    <div class="message-container bot-container">
                        <div class="message bot-msg">Merhaba! Dosyalarƒ±nƒ±zƒ± soldaki panelden y√ºkleyin ve sohbete
                            ba≈ülayƒ±n.</div>
                    </div>
                </div>

                <div class="controls">
                    <input type="text" id="questionInput" placeholder="Sorunuzu buraya yazƒ±n..."
                        onkeypress="if(event.key === 'Enter') askQuestion()">
                    <button class="btn-primary" onclick="askQuestion()" style="flex:0 0 100px;">G√∂nder</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let filesArray = [];
        let serverFiles = [];
        let showAllFiles = false;

        // Elements
        const dropZone = document.getElementById('dropZone');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileCountSpan = document.getElementById('fileCount');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const uploadStatus = document.getElementById('uploadStatus');
        const chatHistory = document.getElementById('chat-history');
        const questionInput = document.getElementById('questionInput');

        // Init
        window.onload = function () {
            loadChatHistory();
            fetchServerFiles();
        };

        // Drag & Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
        });
        dropZone.addEventListener('dragover', () => dropZone.classList.add('dragover'));
        ['dragleave', 'drop'].forEach(eventName => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => addFiles(e.dataTransfer.files));

        // Logic
        async function fetchServerFiles() {
            try {
                // API endpoint g√ºncellendi
                const response = await fetch('/files/list');
                if (!response.ok) throw new Error("Liste alƒ±namadƒ±");

                const data = await response.json();
                serverFiles = data.map(f => ({ name: f, isServer: true }));
                renderFileList();
            } catch (e) { console.error(e); }
        }

        function addFiles(files) {
            for (let file of files) {
                const existsLocal = filesArray.some(f => f.name === file.name);
                const existsServer = serverFiles.some(f => f.name === file.name);
                if (!existsLocal && !existsServer) filesArray.push(file);
            }
            renderFileList();
        }

        function removeFile(name, isServer) {
            if (isServer) {
                serverFiles = serverFiles.filter(f => f.name !== name);
            } else {
                filesArray = filesArray.filter(f => f.name !== name);
            }
            renderFileList();
        }

        function renderFileList() {
            const allFiles = [...serverFiles, ...filesArray];
            fileCountSpan.innerText = `${allFiles.length} dosya`;
            fileListContainer.innerHTML = "";

            if (allFiles.length === 0) {
                analyzeBtn.disabled = true;
                return;
            }
            analyzeBtn.disabled = false;

            const displayFiles = showAllFiles ? allFiles : allFiles.slice(0, 3);

            displayFiles.forEach((file) => {
                const isServer = file.isServer || false;
                const statusColor = isServer ? '#22c55e' : '#f97316';

                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <span style="width:8px; height:8px; background:${statusColor}; border-radius:50%; margin-right:8px;" title="${isServer ? 'Y√ºkl√º' : 'Kaydedilmeyi Bekliyor'}"></span>
                        <span class="file-name" title="${file.name}">${file.name}</span>
                    </div>
                    <span class="remove-btn" onclick="removeFile('${file.name}', ${isServer})">√ó</span>
                `;
                fileListContainer.appendChild(item);
            });

            if (allFiles.length > 3) {
                const moreBtn = document.createElement('div');
                moreBtn.style.textAlign = 'center'; moreBtn.style.padding = '10px'; moreBtn.style.cursor = 'pointer'; moreBtn.style.color = '#2563eb'; moreBtn.style.fontSize = '0.9em';
                moreBtn.innerText = showAllFiles ? "Daha Az G√∂ster" : `+${allFiles.length - 3} Diƒüer Dosya`;
                moreBtn.onclick = () => { showAllFiles = !showAllFiles; renderFileList(); };
                fileListContainer.appendChild(moreBtn);
            }
        }

        async function startAnalysis() {
            const formData = new FormData();
            filesArray.forEach(file => formData.append("files", file));

            analyzeBtn.disabled = true;
            analyzeBtn.innerText = "‚è≥ ...";

            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                const result = await response.json();

                if (response.ok) {
                    uploadStatus.innerText = "‚úÖ Tamamlandƒ±";
                    uploadStatus.className = "status success";
                    filesArray = [];
                    fetchServerFiles();
                } else {
                    throw new Error(result.detail);
                }
            } catch (error) {
                uploadStatus.innerText = "‚ùå " + error.message;
                uploadStatus.className = "status error";
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerText = "üöÄ Analizi Ba≈ülat";
            }
        }

        async function askQuestion() {
            const question = questionInput.value.trim();
            if (!question) return;

            addMessage("user", question);
            saveChatHistory();
            questionInput.value = "";

            // Loading mesajƒ±nƒ± ekle ve ID'sini sakla
            const loadingId = addMessage("bot", "D√º≈ü√ºn√ºyor...", true, false, true); // true = temp

            try {
                const response = await fetch('/ask', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: question })
                });

                const data = await response.json();

                // HATA KONTROL√ú
                if (!response.ok) {
                    const errorMsg = (data.detail && data.detail.includes("√ñNCE BELGE"))
                        ? "‚ö†Ô∏è <b>√ñNCE BELGE Y√úKLEYƒ∞N VE ANALƒ∞Zƒ∞ BA≈ûLATIN</b>"
                        : "‚ùå Hata: " + data.detail;

                    updateMessage(loadingId, errorMsg, true); // Loading mesajƒ±nƒ± g√ºncelle
                    saveChatHistory();
                    return;
                }

                let answerText = data.answer;
                if (data.sources && data.sources.length > 0) {
                    const uniqueSources = [...new Set(data.sources)];
                    const sourcesHtml = uniqueSources.map(src =>
                        `<a href="#" onclick="return false;" style="color:#2563eb; text-decoration:none; background:#eff6ff; padding:2px 6px; border-radius:4px; border:1px solid #bfdbfe;">üìÑ ${src}</a>`
                    ).join("  ");

                    answerText += `<div style="font-size:0.9em; margin-top:8px; border-top:1px solid #ddd; padding-top:8px; color:#666;">
                        <b>üìö Kaynaklar:</b><br><div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">${sourcesHtml}</div>
                    </div>`;
                }

                // Loading mesajƒ±nƒ±n i√ßeriƒüini cevapla deƒüi≈ütir
                updateMessage(loadingId, answerText);
                saveChatHistory();

            } catch (error) {
                updateMessage(loadingId, "‚ùå Baƒülantƒ± hatasƒ±: " + error.message);
            }
        }

        function getTimeString() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        }

        function addMessage(role, text, isHtml = false, isWarning = false, isTemp = false) {
            const container = document.createElement("div");
            container.className = `message-container ${role === 'user' ? 'user-container' : 'bot-container'}`;
            container.id = "params-" + Date.now(); // Container ID

            const msgDiv = document.createElement("div");
            msgDiv.className = `message ${role === 'user' ? 'user-msg' : 'bot-msg'}`;
            if (isWarning) msgDiv.className += " warning-msg";
            msgDiv.id = "msg-" + Date.now(); // Message Content ID

            if (isHtml) msgDiv.innerHTML = text; else msgDiv.innerText = text;

            const timeSpan = document.createElement("span");
            timeSpan.className = "time";
            timeSpan.innerText = getTimeString();

            container.appendChild(msgDiv);
            container.appendChild(timeSpan);

            chatHistory.appendChild(container);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            return msgDiv.id; // ƒ∞√ßeriƒüi deƒüi≈ütirmek i√ßin ID d√∂n
        }

        function updateMessage(id, newText, isWarning = false) {
            const el = document.getElementById(id);
            if (el) {
                el.innerHTML = newText;
                if (isWarning) el.className += " warning-msg";
            }
        }

        function saveChatHistory() {
            localStorage.setItem("chatHistory", chatHistory.innerHTML);
        }

        function loadChatHistory() {
            const saved = localStorage.getItem("chatHistory");
            if (saved) {
                chatHistory.innerHTML = saved;
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        }

        function clearChat() {
            if (confirm("Sohbet silinsin mi?")) {
                localStorage.removeItem("chatHistory");
                chatHistory.innerHTML = '<div class="message-container bot-container"><div class="message bot-msg">Sohbet temizlendi.</div></div>';
            }
        }
    </script>
</body>

</html>
